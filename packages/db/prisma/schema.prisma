generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// Multi-tenant LMS Models
// ========================================

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())

  // Relations
  users   User[]
  courses Course[]

  @@index([slug])
}

model User {
  id        String   @id @default(cuid())
  tenantId  String
  email     String   @unique
  name      String
  role      String // "student", "instructor", "admin"
  createdAt DateTime @default(now())

  // Relations
  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversations     AIConversation[]
  courseMemberships CourseMembership[]
  uploadedDocuments Document[]         @relation("UserDocuments")

  @@index([tenantId])
  @@index([email])
}

model Course {
  id          String   @id @default(cuid())
  tenantId    String
  title       String
  description String
  createdAt   DateTime @default(now())

  // Relations
  tenant         Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  modules        Module[]
  pages          Page[]
  memberships    CourseMembership[]
  assignments    Assignment[]
  calendarEvents CalendarEvent[]
  documents      Document[]

  @@index([tenantId])
}

model Module {
  id        String   @id @default(cuid())
  courseId  String
  name      String
  position  Int
  createdAt DateTime @default(now())

  // Relations
  course      Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  pages       Page[]
  assignments Assignment[]
  documents   Document[]

  @@index([courseId])
  @@index([courseId, position])
}

model Page {
  id           String   @id @default(cuid())
  courseId     String
  moduleId     String?
  title        String
  bodyMarkdown String   @db.Text
  createdAt    DateTime @default(now())

  // Relations
  course Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  module Module? @relation(fields: [moduleId], references: [id], onDelete: SetNull)

  @@index([courseId])
  @@index([moduleId])
}

model CourseMembership {
  id        String   @id @default(cuid())
  courseId  String
  userId    String
  role      String // "instructor" or "student"
  createdAt DateTime @default(now())

  // Relations
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([courseId, userId])
}

model Assignment {
  id          String   @id @default(cuid())
  courseId    String
  moduleId    String?
  name        String
  description String
  dueAt       DateTime
  points      Int      @default(100)
  createdAt   DateTime @default(now())

  // Relations
  course         Course          @relation(fields: [courseId], references: [id], onDelete: Cascade)
  module         Module?         @relation(fields: [moduleId], references: [id], onDelete: SetNull)
  calendarEvents CalendarEvent[]
  documents      Document[]

  @@index([courseId])
  @@index([moduleId])
}

model CalendarEvent {
  id           String   @id @default(cuid())
  courseId     String
  title        String
  description  String
  startAt      DateTime
  endAt        DateTime
  assignmentId String?
  createdAt    DateTime @default(now())

  // Relations
  course     Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  assignment Assignment? @relation(fields: [assignmentId], references: [id], onDelete: SetNull)

  @@index([courseId])
}

// ========================================
// AI Layer Models
// ========================================

model Tool {
  id                  String   @id @default(cuid())
  name                String   @unique // machine name, e.g., "search_course_content"
  displayName         String
  description         String   @db.Text
  inputSchema         Json
  outputSchema        Json
  implementationRef   String // e.g. "assessment-service:/tools/..."
  permissionsRequired String // comma-separated list
  contextTypes        String // e.g. "course_page,module_page"
  latencyClass        String // "sync" | "async"
  version             String
  createdAt           DateTime @default(now())

  // Relations
  agents AgentTool[]

  @@index([name])
}

model Agent {
  id            String   @id @default(cuid())
  name          String   @unique // machine name, e.g., "content_helper"
  description   String   @db.Text
  defaultModel  String // e.g., "gpt-4-turbo"
  contextPolicy Json // { maxTokens, includeUserHistory, includeCourseContext, â€¦ }
  uiSurfaces    String // e.g., "side_panel,command_palette,inline_chat"
  targetRoles   String // e.g., "student,instructor"
  createdAt     DateTime @default(now())

  // Relations
  tools         AgentTool[]
  conversations AIConversation[]

  @@index([name])
}

model AgentTool {
  id       String @id @default(cuid())
  agentId  String
  toolId   String
  priority Int    @default(0)

  // Relations
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)
  tool  Tool  @relation(fields: [toolId], references: [id], onDelete: Cascade)

  @@unique([agentId, toolId])
}

model AIConversation {
  id        String                  @id @default(cuid())
  agentId   String
  userId    String
  courseId  String?
  pageId    String?
  createdAt DateTime                @default(now())
  messages  AIConversationMessage[]

  // Relations
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([userId])
  @@index([courseId])
}

model AIConversationMessage {
  id             String   @id @default(cuid())
  conversationId String
  role           String // "user" | "agent"
  content        String   @db.Text
  metadata       Json? // optional tool calls, context used, etc.
  createdAt      DateTime @default(now())

  // Relations
  conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

// ========================================
// Document Storage Model
// ========================================

model Document {
  id           String  @id @default(cuid())
  courseId     String
  moduleId     String?
  assignmentId String?

  title        String
  fileName     String // stored filename
  originalName String
  mimeType     String
  size         Int // bytes
  url          String

  uploadedBy String
  createdAt  DateTime @default(now())

  // Relations
  course     Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  module     Module?     @relation(fields: [moduleId], references: [id], onDelete: SetNull)
  assignment Assignment? @relation(fields: [assignmentId], references: [id], onDelete: SetNull)
  uploader   User        @relation("UserDocuments", fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@unique([fileName])
  @@index([courseId])
  @@index([moduleId])
  @@index([assignmentId])
}
